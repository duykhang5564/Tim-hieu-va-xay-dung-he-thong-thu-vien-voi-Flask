{% extends "layout.html" %}
{% block content %}
<!-- Form tìm kiếm (Giữ nguyên) -->
<div class="search-section mb-5">
    <div class="d-flex align-items-center mb-3 ms-2">
        <i class="bi bi-search-heart-fill text-primary fs-4 me-2"></i>
        <span class="search-label-blue" style="font-size: 1.3rem;">Tìm kiếm sách</span>
    </div>

    <form action="{{ url_for('index') }}" method="GET" class="search-card-pro p-4">
        <div class="row g-3">
            <div class="col-lg-3 col-md-6">
                <input type="text" class="form-control capsule-input" name="q_title" 
                       placeholder="Nhập tên sách..." value="{{ q_title or '' }}">
            </div>
            
            <div class="col-lg-3 col-md-6">
                <input type="text" class="form-control capsule-input" name="q_author" 
                       placeholder="Nhập tác giả..." value="{{ q_author or '' }}">
            </div>
            
            <div class="col-lg-2 col-md-4">
                <select class="form-select capsule-input" name="q_category">
                    <option value="">-- Thể loại --</option>
                    {% for c in categories %}
                    <option value="{{ c.id }}" {% if q_category == c.id|string %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-lg-2 col-md-4">
                <select class="form-select capsule-input" name="q_language">
                    <option value="">-- Ngôn ngữ --</option>
                    {% for l in languages %}
                    <option value="{{ l.id }}" {% if q_language == l.id|string %}selected{% endif %}>{{ l.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-lg-2 col-md-4">
                <button type="submit" class="btn btn-search-pro w-100">
                    <i class="bi bi-search me-2"></i>Tìm kiếm
                </button>
            </div>
        </div>
    </form>
</div>

<table class="table table-striped align-middle">
    <thead class="table-dark">
        <tr>
            <th style="width: 10%;">Ảnh bìa</th>
            <th style="width: 30%;">Tên sách & Trạng thái</th>
            <th>Tác giả</th>
            <th>Thể loại</th>
            <th>Giá</th>
            <th class="text-center">Hành động</th>
        </tr>
    </thead>
    <tbody>
        {% for book in books %}
        <tr>
            <td>
                <img src="{{ url_for('static', filename='book_covers/' + book.image_file) }}" class="img-thumbnail" style="width: 70px; height: 100px; object-fit: cover;">
            </td>
            <td>
                <a href="{{ url_for('view_book', id=book.id) }}" class="fw-bold text-decoration-none">{{ book.title }}</a>
                <!--! <<< CẬP NHẬT: Hiển thị số lượng >>> -->
                <div class="mt-1">
                    {% if book.available_quantity > 0 %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle-fill"></i> Còn {{ book.available_quantity }} / {{ book.total_quantity }}
                        </span>
                    {% else %}
                        <span class="badge bg-danger">
                            <i class="bi bi-x-circle-fill"></i> Đã hết sách
                        </span>
                    {% endif %}
                </div>
            </td>
            <td>{{ book.author.name }}</td>
            <td>{{ book.category.name }}</td>
            <td>{{ "{:,.0f} đ".format(book.price) if book.price else '-' }}</td>
            <td class="text-center">
                {% if not current_user.is_admin %}
                        
                    {% if book.id in wishlist_book_ids %}
                        <a href="{{ url_for('toggle_wishlist', book_id=book.id) }}" 
                            class="btn btn-sm btn-danger me-1" 
                            title="Bỏ thích">
                            <i class="bi bi-heart-fill"></i>
                        </a>
                    {% else %}
                        <a href="{{ url_for('toggle_wishlist', book_id=book.id) }}" 
                            class="btn btn-sm btn-outline-danger me-1" 
                            title="Thêm vào yêu thích">
                            <i class="bi bi-heart"></i>
                        </a>
                    {% endif %}

                {% endif %}

    {% if current_user.is_admin %}
        <a href="{{ url_for('edit_page', id=book.id) }}" class="btn btn-sm btn-warning"><i class="bi bi-pencil"></i></a>
        <a href="{{ url_for('delete_book', id=book.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Xóa sách này?')"><i class="bi bi-trash"></i></a>
    {% else %}
        <a href="{{ url_for('view_book', id=book.id) }}" class="btn btn-sm btn-info text-white"><i class="bi bi-eye-fill"></i> Xem</a>
    {% endif %}
</td>
        
           
        </tr>
        {% else %}
        </tr>
            <td colspan="6" class="text-center">Không tìm thấy sách nào.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">

        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link bg-dark text-light border-secondary"
               href="{{ url_for('index', page=pagination.prev_num,
                                q_title=q_title,
                                q_author=q_author,
                                q_category=q_category,
                                q_language=q_language) }}">
                «
            </a>
        </li>

        <li class="page-item active">
            <span class="page-link bg-primary text-white border-primary">
                Trang {{ pagination.page }} / {{ pagination.pages if pagination.pages > 0 else 1 }}
            </span>
        </li>

        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link bg-dark text-light border-secondary"
               href="{{ url_for('index', page=pagination.next_num,
                                q_title=q_title,
                                q_author=q_author,
                                q_category=q_category,
                                q_language=q_language) }}">
                »
            </a>
        </li>
    </ul>
</nav>
{% endblock %}
